# Landing Zone skeleton covering installment and dependencies for governance baseline and security
# Nested workflows Integration launches main-data

name: Landing Zone Data well-governed v5 

run-name: "Well-Architected modular instantation workflow" 

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write
  actions: write
  security-events: write

on:
  workflow_dispatch: 
  workflow_call: 
    secrets:
        INHERIT_TOKEN:
          required: true
  schedule:
    - cron: '0 3 * * 5'  # Weekly on Sundays at 3AM UTC

jobs:
  terraform:
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
          TF_VAR_github_token: ${{ secrets.INHERIT_TOKEN }}
          
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Remove Terraform lock file
        run: |
          if [ -f "modules/github-ruleset/.terraform.lock.hcl" ]; then
            echo "Removing Terraform lock file..."
            rm .terraform.lock.hcl
          else
            echo "No lock file found."
          fi
          
      - name: Terraform Init
        run: terraform init -reconfigure

      - name: Terraform Plan
        working-directory: .
        run: |
          set -e
          export github_token=${{ secrets.INHERIT_TOKEN }}
           terraform state list | grep github_repository_ruleset | tr -d '\r' | while read -r r; do
           terraform state rm "$r" || true
           done;
          terraform plan -out=tfplan 
          echo "Terraform Validated and Plan is completed"

      - name: Show Terraform Plan (text output)
        working-directory: .
        run: |
          if [ ! -f tfplan ]; then
            echo "ERROR: tfplan not found"
            exit 1
          fi
          terraform show -no-color tfplan

      - name: Terraform Apply
        working-directory: .
        run: |
          terraform apply -auto-approve tfplan
        
  tests:
    runs-on: ubuntu-latest
    needs: terraform

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Python dependencies
        working-directory: .
        run: |
          python -m pip install --upgrade pip
          python -m pip install pandas setuptools wheel
          if [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          fi

      - name: Run Basic Tests
        run: |
          if ls test_*.py >/dev/null 2>&1; then
            pytest test_datalz22.py
            echo "Python tests executed"
          else
            echo "No Python tests found â€” skipping"
          fi

      - name: Run Tests with Coverage
        run: |
          pip install pytest-cov
          pytest --cov=. --cov-report=xml
