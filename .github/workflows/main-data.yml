# Landing Zone skeleton covering installment and dependencies for governance baseline and security
# Nested workflows Integration launches main-data

name: Landing Zone Data well-governed v4


permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write
  actions: write
  artifact-metadata: read
  repository-projects: write

on:
  push:
    branches:
      - main
      - ArchDecisions-v3
  workflow_call:
    secrets:
      INHERIT_TOKEN:
        required: true

jobs:
  terraform:
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform Init (clean state)
        working-directory: .
        env:
          TF_VAR_github_token: ${{ secrets.INHERIT_TOKEN }}
        run: |
          echo "Cleaning Terraform state and reinitializing"
          rm -rf .terraform
          terraform init -reconfigure

      - name: Terraform Plan
        working-directory: .
        env:
          TF_VAR_github_token: ${{ secrets.INHERIT_TOKEN }}
        run: |
          set -e
          terraform plan -out=tfplan -input=false
          echo "Plan completed"

      - name: Show Terraform Plan (text output)
        working-directory: .
        run: |
          if [ ! -f tfplan ]; then
            echo "ERROR: tfplan not found"
            exit 1
          fi
          terraform show -no-color tfplan

      - name: Terraform Apply
        working-directory: .
        env:
          TF_VAR_github_token: ${{ secrets.INHERIT_TOKEN }}
        run: |
          echo "Applying Terraform changes"
          terraform apply -auto-approve
          echo "Terraform apply completed"

  tests:
    runs-on: ubuntu-latest
    needs: terraform

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Python dependencies
        working-directory: .
        run: |
          python -m pip install --upgrade pip
          python -m pip install pandas setuptools wheel
          if [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          fi

      - name: Run Basic Tests
        run: |
          if ls test_*.py >/dev/null 2>&1; then
            pytest test_datalz22.py
            echo "Python tests executed"
          else
            echo "No Python tests found â€” skipping"
          fi

      - name: Run Tests with Coverage
        run: |
          pip install pytest-cov
          pytest --cov=. --cov-report=xml
