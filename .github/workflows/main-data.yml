# Landing Zone skeleton covering installment and dependencies for governance baseline and security
# Nested workflows Integration launches main-data

name: Landing Zone Data well-governed v5 

run-name: "Well-Architected modular instantation workflow" 

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write
  actions: write
  security-events: write
  repository-projects: write

on:
  workflow_call:
    secrets:
      TF_VAR_INHERIT_TOKEN2:
        required: true  
  schedule:
    - cron: '0 3 * * 5'  # Weekly on Sundays at 3AM UTC
    
jobs:
  terraform:
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      TF_VAR_INHERIT_TOKEN2: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Debug token length
        run: |
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "Token is EMPTY"
          else
            echo "Token length: ${#GITHUB_TOKEN}"
          fi
        shell: bash

      - name: Remove Terraform lock files and folders
        run: |
          if [ -f ".terraform.lock.hcl" ]; then
            echo "Removing Terraform lock file..."
            rm -rf .terraform.lock.hcl
            else
            echo "No lock file found."
          fi
          
      - name: Terraform Init
        working-directory: .
        run: |
         # rm -rf .terraform
         terraform state list \
          | grep github_repository_ruleset \
          | grep -v "::" \
          | tr -d '\r' \
          | while read -r r; do
          terraform state rm "$r" || true
          done
         terraform init -reconfigure
         echo "Clean install with corrected providers, upgrade might be optional and block providers are different, we choose the stable version for integration modules"
         
      - name: Terraform Plan
        working-directory: .
        run: |
          terraform plan -var-file="terraform.tfvars"
          echo "Terraform Config is all validated and completed, promote to prod github runner can continue"

      - name: Verify lock file exists at root
        run: |
          if [ ! -f ".terraform.lock.hcl" ]; then
            echo "ERROR: Lock file missing at root"
            exit 1
          fi

      # Output of tfplan as proof for security audits and compliancy
      - name: Show Terraform Plan (text output)
        working-directory: .
        run: |
          if [ ! -f tfplan ]; then
            echo "ERROR: tfplan not found"
            exit 1
          fi
          terraform show -no-color 

      - name: Terraform Apply
        working-directory: .
        run: |
          terraform apply -auto-approve
        
  tests:
    runs-on: ubuntu-latest
    needs: terraform

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          
      # Panda, wheel and dependencies are crucial, unit tested working-directory
      - name: Install Python dependencies
        working-directory: .
        run: |
          python -m pip install --upgrade pip
          python -m pip install pandas setuptools wheel
          if [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          fi

      # Cucumber-js will be installed and configured next to this, making sure the frame is vast
      - name: Run Basic Tests for any further integration with Core Python
        run: |
          if ls test_*.py >/dev/null 2>&1; then
            pytest test_datalz22.py
            echo "Python tests executed"
          else
            echo "No Python tests found â€” skipping"
          fi

      - name: Run Tests with Coverage
        run: |
          pip install pytest-cov
          pytest --cov=. --cov-report=xml
